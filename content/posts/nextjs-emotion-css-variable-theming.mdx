---
title: 'Next.js, Emotion & CSS Variable Theming'
date: '2021-20-03'
excerpt: 'A Next.js setup taking aspects of several great tools and techiques.'
author: 'Tom Hendra'
image: '/images/gadgets.jpg'
caption: 'An image of gadgets.'
tags: ['Next.js', 'Emotion', 'CSS', 'Theme UI']
---

I recently decided to revamp my blog for the third time, and like many others decided to follow the trend from Gatsby to Next.js. My old blog had served me well but was too complex for my needs. It was the first thing I ever built with React and I got carried away, essentially creating a reusbale component library for a one-off website with a Sanity.io CMS. It was fun to build and I learned a tonne, but it was like using a jet turbine to power my lawnmower. I needed to approach the subsequent iteration with a gentler hand.

Next.js is still overkill, I mean who needs an all-powerful fullstack React Framwork for a simeple blog? But I am eager to learn Next.js as that's what all the cool kids are doing, so the choice was made.

## Styling

I love a great developer experience (DX) as much as the next person, which is why I ended up going too far with my Gatsby site's components. All four pages for the site were written in squeaky clean markup because I spent a lot of time creating a nice component API. I avoided having to use Emotion's css prop in my pages and instead accepted style props in my components for all possible use cases like a component library might do, ladeling on the complexity.

But I am not building a design system (yet) so I decided to explore what options were available to spare me from a. spending too much time writing component code and b. the horror of writing untidy code for my pages, with css prop styles all over the place for tweaking spacing here and there chasing pixel-perfection.

## Theme UI

I stumbled across Theme UI and really liked the underlying principles of a standardized theme specification. Theme UI isn't just some venture into the unknown clutching a fancy idea, the developers created it with careful consideration derived from lessons learned during the evolution of several other libraries that came before it, which gives it credibility. I spent quite some time reviewing Theme UI, and while I enjoyed the DX, I didn't enjoy fighting with alpha versions and configs for compatability with the latest version of Next.js. I also struggled to find answers to questions for what is a surprisingly unpopular styling solution. It was also too much abstraction, since I want to grow my CSS skills, and Theme UI obscures much of it.

## Tailwind CSS

Tailwind has gained a lot of traction and for good reasaon; the underlying design system is sublime. Having the glorious Refactoring UI in my toolkit I have tremendous respect for Adam Wathan & Steve Schoger's work. Refactoring UI opens portals from the developer realm to the design world, and the result is like using Figma with cheat codes. But seeing a troupe of classnames lined up makes me feel uneasy. Given the glowing feedback Talwind receives, I am sure the unease subsides with acclimitization, and I fully intend to test that theory at some point. But for now Tailwind doesn't meet the cut because easy to read and maintain code for my blog - a testing ground for all the shiny new things - needs to be free from chaos.

## Emotion

Familiar territory and the lightbulb moment came next. I'm already on good terms with Emotion after the Gatsby site I spent so much time iterating upon and learning from. Why not take some features from Theme UI, and implement them myself with Emotion? After all, Theme UI is built upon Emotion itself. That way I can stay closer to vanilla CSS and get to learn about how Theme UI works. Sure it might be more work, but hey, I get to tinker and it'll be more rewarding in the end.

## CSS Variable Theming

React guru, Kent C Dodds, enlightened me to the performance benefits of CSS variables over React context with his blog post [Use CSS Variables instead of React Context](https://epicreact.dev/css-variables/). Performance always matters, and with [95% browser coverage](https://caniuse.com/css-variables) it was an easy sell. In terms of how to put together colour swatches as part of a design system, Elad Shechter had me covered with his article on [Why CSS HSL Colors are Better!](https://elad.medium.com/why-css-hsl-colors-are-better-83b1e0b6eead). The plan was in place.

## Putting it All Together

So how do we stitch all of this together for performant, well-organized theming coupled with the great DX of Emotion? Well, we create a hybrid by following these steps.

1. Setup Emotion to work with the latest version of Next.js.
2. Take some design system elements from Tailwind and CSS Variable configuration from from Kent C Dodds and Elad Shechter
3. Create an object theme based on the theme specification from Theme UI that consumes CSS Variables.
4. Create a toggle component to switch between light and dark themes.

## Configuring Emotion with Next.js

Emotion 11 installation is as easy as `npm i @emotion/react @emotion/styled`. To avoid having to use a pragma atop every file that relies on the Emotion `css` prop, we also want to `npm i @emotion/babel-plugin`. For the plugin to work, and to use [the new JSX transform](https://reactjs.org/blog/2020/09/22/introducing-the-new-jsx-transform.html) in React 17 which ships with the latest verion of Next.js, we need to define a custom Babel config as follows in a `.babelrc` file in the root directory.

```shell
{
  "presets": [
    [
      "next/babel",
      {
        "preset-react": {
          "runtime": "automatic",
          "importSource": "@emotion/react"
        }
      }
    ]
  ],
  "plugins": ["@emotion/babel-plugin"]
}
```

## Defining CSS Variables for our Theme

We define our colour scales Tailwind-style using CSS variables based on the teachings of Kent C Dodds and Elad Shechter.

```css
/* styles/colors.css */
:root {
  --gray: 343, 6%;
  --gray-50: var(--gray), 95%;
  --gray-100: var(--gray), 90%;
  --gray-200: var(--gray), 80%;
  --gray-300: var(--gray), 70%;
  --gray-400: var(--gray), 60%;
  --gray-500: var(--gray), 50%;
  --gray-600: var(--gray), 40%;
  --gray-700: var(--gray), 30%;
  --gray-800: var(--gray), 20%;
  --gray-900: var(--gray), 10%;

  --teal: 163, 19%;
  --teal-50: var(--teal), 95%;
  --teal-100: var(--teal), 90%;
  --teal-200: var(--teal), 80%;
  --teal-300: var(--teal), 70%;
  --teal-400: var(--teal), 60%;
  --teal-500: var(--teal), 50%;
  --teal-600: var(--teal), 40%;
  --teal-700: var(--teal), 30%;
  --teal-800: var(--teal), 20%;
  --teal-900: var(--teal), 10%;

  --yellow: 40, 91%;
  --yellow-50: var(--yellow), 95%;
  --yellow-100: var(--yellow), 90%;
  --yellow-200: var(--yellow), 80%;
  --yellow-300: var(--yellow), 70%;
  --yellow-400: var(--yellow), 60%;
  --yellow-500: var(--yellow), 50%;
  --yellow-600: var(--yellow), 40%;
  --yellow-700: var(--yellow), 30%;
  --yellow-800: var(--yellow), 20%;
  --yellow-900: var(--yellow), 10%;

  --olive: 72, 25%;
  --olive-50: var(--olive), 95%;
  --olive-100: var(--olive), 90%;
  --olive-200: var(--olive), 80%;
  --olive-300: var(--olive), 70%;
  --olive-400: var(--olive), 60%;
  --olive-500: var(--olive), 50%;
  --olive-600: var(--olive), 40%;
  --olive-700: var(--olive), 30%;
  --olive-800: var(--olive), 20%;
  --olive-900: var(--olive), 10%;

  --orange: 14, 92%;
  --orange-50: var(--orange), 95%;
  --orange-100: var(--orange), 90%;
  --orange-200: var(--orange), 80%;
  --orange-300: var(--orange), 70%;
  --orange-400: var(--orange), 60%;
  --orange-500: var(--orange), 50%;
  --orange-600: var(--orange), 40%;
  --orange-700: var(--orange), 30%;
  --orange-800: var(--orange), 20%;
  --orange-900: var(--orange), 10%;
}

body[data-theme='light'] {
  --colors-text: hsla(var(--gray-800), 100%);
  --colors-background: hsla(var(--yellow-50), 100%);
  --colors-primary: hsla(var(--orange-500), 100%);
  --colors-secondary: hsla(var(--orange-300), 100%);
  --colors-accent: hsla(var(--olive-600), 100%);
  --colors-highlight: hsla(var(--teal-200), 100%);
  --colors-muted: hsla(var(--yellow-200), 100%);
}

body[data-theme='dark'] {
  --colors-text: hsla(var(--yellow-50), 100%);
  --colors-background: hsla(var(--gray-800), 100%);
  --colors-primary: hsla(var(--orange-500), 100%);
  --colors-secondary: hsla(var(--orange-300), 100%);
  --colors-accent: hsla(var(--olive-600), 100%);
  --colors-highlight: hsla(var(--teal-200), 100%);
  --colors-muted: hsla(var(--yellow-200), 100%);
}
```

## Creating & Using a Theme with Emotion

Then we follow [Theme UI's theme specification](https://dev.theme-ui.com/theme-spec/) to build a thoughtfully structured theme, using our CSS variables for the `colors` section.

```ts
const baseColors = {
  transparent: 'transparent',
  black: '#000',
  white: '#fff',
  gray: [
    'var(--gray-50)',
    'var(--gray-100)',
    'var(--gray-200)',
    'var(--gray-300)',
    'var(--gray-400)',
    'var(--gray-500)',
    'var(--gray-600)',
    'var(--gray-700)',
    'var(--gray-800)',
    'var(--gray-900)',
  ],
  teal: [
    'var(--teal-50)',
    'var(--teal-100)',
    'var(--teal-200)',
    'var(--teal-300)',
    'var(--teal-400)',
    'var(--teal-500)',
    'var(--teal-600)',
    'var(--teal-700)',
    'var(--teal-800)',
    'var(--teal-900)',
  ],
  yellow: [
    'var(--yellow-50)',
    'var(--yellow-100)',
    'var(--yellow-200)',
    'var(--yellow-300)',
    'var(--yellow-400)',
    'var(--yellow-500)',
    'var(--yellow-600)',
    'var(--yellow-700)',
    'var(--yellow-800)',
    'var(--yellow-900)',
  ],
  olive: [
    'var(--olive-50)',
    'var(--olive-100)',
    'var(--olive-200)',
    'var(--olive-300)',
    'var(--olive-400)',
    'var(--olive-500)',
    'var(--olive-600)',
    'var(--olive-700)',
    'var(--olive-800)',
    'var(--olive-900)',
  ],
  orange: [
    'var(--orange-50)',
    'var(--orange-100)',
    'var(--orange-200)',
    'var(--orange-300)',
    'var(--orange-400)',
    'var(--orange-500)',
    'var(--orange-600)',
    'var(--orange-700)',
    'var(--orange-800)',
    'var(--orange-900)',
  ],
};

const defaultColors = {
  text: 'var(--colors-text)',
  background: 'var(--colors-background)',
  primary: 'var(--colors-primary)',
  secondary: 'var(--colors-secondary)',
  accent: 'var(--colors-accent)',
  highlight: 'var(--colors-highlight)',
  muted: 'var(--colors-muted)',
};

export const colors = {
  ...baseColors,
  ...defaultColors,
};
```

Next we use Emotion's `<Global/>` component to apply the theme colors.

```tsx
// _app.tsx
import type { AppProps } from 'next/app';
import { Global } from '@emotion/react';
import theme from 'theme';
import 'styles/colors.css';

function App({ Component, pageProps }: AppProps) {
  return (
    <>
      <Global
        styles={{
          body: {
            background: theme.colors.background,
            color: theme.colors.text,
          },

          a: {
            color: theme.colors.primary,
          },
        }}
      />
      <Component {...pageProps} />
    </>
  );
}

export default App;
```

## Building a Theme Toggle Component

Lastly we create a theme toggle to switch between themes using CSS [data attributes](https://developer.mozilla.org/en-US/docs/Learn/HTML/Howto/Use_data_attributes).

```tsx
// ModeToggle.tsx
import * as React from 'react';
import { FiSun, FiMoon } from 'react-icons/fi';
import { StyledButton } from './styled';
import { useLocalStorageState } from 'hooks';

export function ModeToggle() {
  const [theme, setTheme] = React.useState('light');
  const nextTheme = theme === 'light' ? 'dark' : 'light';

  React.useEffect(() => {
    document.body.dataset.theme = theme;
  }, [theme]);

  return (
    <StyledButton
      aria-label="Toggle colour mode"
      onClick={() => setTheme(nextTheme)}
    >
      {nextTheme === 'light' ? <FiMoon /> : <FiSun />}
    </StyledButton>
  );
}
```

And just like that, now we can have the best of everything!

## Just One More Thing...

But there is one more matter to consider. Next.js re-renders on route changes and therefore our theme state will be lost when we navigate to a different page. We need to persist state, for which we will use `localStorage`.

## Persisting Between Route Changes

One of the many elegant patterns I learned from Kent C Dodd's [Epic React](https://epicreact.dev/) course is to create a generic custom hook for storing state in `localStorage`. To avoid an error being thrown, we also need to ensure not to try and access `window` on the server where it will be `undefined` as per the [Next.js docs](https://nextjs.org/docs/migrating/from-create-react-app#safely-accessing-web-apis).

```tsx
// use-local-storage-state.tsx
import * as React from 'react';

export function useLocalStorageState(
  key: string,
  defaultValue: string | (() => void),
  { serialize = JSON.stringify, deserialize = JSON.parse } = {},
) {
  const [state, setState] = React.useState(() => {
    // do not try to run this on the server!
    if (typeof window === 'undefined') return;
    const valueInLocalStorage = window.localStorage.getItem(key);

    if (valueInLocalStorage) {
      // the try/catch is here in case the localStorage value was set before we had the serialization in place
      try {
        return deserialize(valueInLocalStorage);
      } catch (error) {
        window.localStorage.removeItem(key);
      }
    }
    return typeof defaultValue === 'function' ? defaultValue() : defaultValue;
  });

  const prevKeyRef = React.useRef(key);

  React.useEffect(() => {
    const prevKey = prevKeyRef.current;
    if (prevKey !== key) {
      window.localStorage.removeItem(prevKey);
    }
    prevKeyRef.current = key;
    window.localStorage.setItem(key, serialize(state));
  }, [key, state, serialize]);

  return [state, setState];
}
```

Now we can replace the call to `React.useState()` with `useLocalStorageState()` in our `ModeToggle` component.

```tsx
import { FiSun, FiMoon } from 'react-icons/fi';
import { StyledButton } from './styled';
import { useLocalStorageState } from 'hooks';

export function ModeToggle() {
  const [theme, setTheme] = useLocalStorageState('theme', 'light');
  const nextTheme = theme === 'light' ? 'dark' : 'light';

  React.useEffect(() => {
    document.body.dataset.theme = theme;
  }, [theme]);

  return (
    <StyledButton
      aria-label="Toggle colour mode"
      onClick={() => setTheme(nextTheme)}
    >
      {nextTheme === 'light' ? <FiMoon /> : <FiSun />}
    </StyledButton>
  );
}
```

## Summary

And there we have it. To recap, we can have a setup with nice DX which includes:

- Emotion for [all of the benefits](https://mxstbr.com/thoughts/css-in-js/) that CSS-in-JS brings, configured to work with the latest version of Next.js.
- Perforamant theming through the use of CSS Custom Properties (variables).
- An organized theme structure based on the theme specification from Theme UI.
- An elegant reusable hook for storing anything we wish in the browser's local storage.

In the outset of my 2021 blog revamp I wanted to avoid two things that bothered me while coding the previous version:

1.  Spending too much time writing component code
2.  Writing untidy code for my pages

The search for technical solutions to these problems gave rise to some unexpected self-reflection. While tools like Theme UI and Tailwind CSS are great for speedy development, in the interest of growing my CSS skills I found that I wasn't really confortable with their level of abstraction.

Sometimes problems can be soloved with a change in mindset. Inb my case, I am building a personal blog with a handful of pages. When I start building a design system of components then I can focus on delivering a clean component API for a nice developer experience. But for my little space on the internet, it really isn't necessary to do so. If the few pages I need use the css prop here and there in the markup, then so be it.

The lesson I have learned? - Always use a suitable approach for the task at hand, and do not create complexity where it isn't justifiable.
